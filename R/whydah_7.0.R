setwd("~/Desktop/Whydah Project/whydah/Data")

options(java.parameters = "-Xmx1g" )
Sys.setenv(NOAWT=TRUE)
library(rJava)
library(gurobi)
library(spThin)
library(ENMeval)
library(dismo)
library(jsonlite)
library(sp)
library(rgdal)
library(maptools)
library(raster)
library(devtools)
library(scales)
library(ggplot2)
library(RColorBrewer)
library(rgbif)
library(dplyr)
library(scales)
library(ecospat)
library(gridExtra)
library(scales)
library(plyr)
library(phyloclim)
library(SDMTools)
data("wrld_simpl")
set.seed(1) #makes sure we're generating the same random numbers

####################################################################################################
####################################   Whydah Occurrences   ########################################
####################################################################################################

# Download occurrences
# ptw <- gbif('Vidua', 'macroura', geo=T, removeZeros = T)
# save(ptw, file="ptw.rdata")
load("ptw.rdata")
head(ptw)
dim(ptw)
ptw<-subset(ptw, basisOfRecord == "HUMAN_OBSERVATION")

### South Africa Points ##
ptw_south_africa<-subset(ptw, country == "South Africa")
dim(ptw_south_africa)
head(ptw_south_africa)
list(ptw_south_africa$datasetName)
count(ptw_south_africa$datasetName == "Southern African Bird Atlas Project 2")

# First, get index numbers for rows that have "SABP2" as their dataset name
rows_with_SABP2 <- which(ptw$datasetName == "Southern African Bird Atlas Project 2")
# remove those rows
ptw_no_SABP <- ptw[-rows_with_SABP2, ] 
count(ptw_no_SABP$datasetName == "Southern African Bird Atlas Project 2")

# Explore south africa more
ptw_south_africa_2 <- subset(ptw_no_SABP, country == "South Africa")
dim(ptw_south_africa_2)
head(ptw_south_africa_2)
# options(max.print = 30000)
table(ptw_south_africa_2$collectionCode)

remove_transects_rows <- which(ptw_south_africa_2$collectionCode == "EBIRD" | 
                                 ptw_south_africa_2$collectionCode == "EBIRD_AU" | 
                                 ptw_south_africa_2$collectionCode == "EBIRD_CAN" | 
                                 ptw_south_africa_2$collectionCode == "naturgucker" | 
                                 ptw_south_africa_2$collectionCode == "Observations" | 
                                 ptw_south_africa_2$collectionCode == "SAFRING")
remove_transects_rows

south_africa_no_transects <- ptw_south_africa_2[remove_transects_rows, ] 
table(south_africa_no_transects$collectionCode)

write.csv(south_africa_no_transects, file = "south_africa_no_transects.csv")

## Remove ALL South African Points
head(ptw_no_SABP$country)
ptw_no_south_africa <- filter(ptw_no_SABP, country !="South Africa")
list(ptw_no_south_africa$country)

# Merge with our much better SA whydah points
dim(ptw_no_south_africa)
dim(south_africa_no_transects)
new_ptw <- rbind(ptw_no_south_africa, south_africa_no_transects)
dim(new_ptw)

ptw_subset <- new_ptw[,c('lon','lat','country','species')]
ptw_subset<-subset(ptw_subset, !is.na(lat) & !is.na(lon))
ptw.unique<- distinct(select(ptw_subset,lon,lat,country,species)) #remove duplicates
dim(ptw.unique)
head(ptw.unique)
plot(wrld_simpl)
points(ptw.unique, cex = .2, col = "red")
# write.csv(ptw.unique, file = "ptw.unique.csv")

# Removing outliers
unique(ptw.unique$country) #Remove Taiwan Whydahs
count(ptw.unique$country)
ptw.unique<-filter(ptw.unique, country !=c("Taiwan")) #get rid of Taiwan sightings.
ptw.unique<-filter(ptw.unique, country !=c("United Arab Emirates"))
ptw.unique<-filter(ptw.unique, country !=c("Spain"))
ptw.unique<-filter(ptw.unique, country !=c("Dominican Republic"))
ptw.unique<-filter(ptw.unique, country !=c("Portugal"))

# Can use this code to check number of records in a particular country
plot(wrld_simpl)
points(ptw.unique, cex = .2, col = "red")

ca_point <- which(ptw.unique$lon<(-122) & ptw.unique$lat>35 & ptw.unique$country=="United States") #San Fran point
ca_point
ptw.unique<-ptw.unique[-ca_point,] #remove san fran point
dim(ptw.unique)

# Remove California Point
ca_point_2 <- which(ptw.unique$lon<(-85) & ptw.unique$lon>(-90) & ptw.unique$lat>28 & ptw.unique$lat<32 & ptw.unique$country=="United States")
ca_point_2
ptw.unique <- ptw.unique[-ca_point_2,]
dim(ptw.unique)

# Remove random island in eastern atlantic
eastern_atlantic_island_point <- which(ptw.unique$lon<(1) & ptw.unique$lon>(-2) & ptw.unique$lat>(-28) & ptw.unique$lat<(-24))
eastern_atlantic_island_point
ptw.unique<-ptw.unique[-eastern_atlantic_island_point,]
dim(ptw.unique)

# Remove Reunion Points
# filter(ptw.unique, lon<(57) & lon>(53) & lat>(-24) & lat<(-19))
# which(ptw.unique$lon == 55.2873, ptw.unique$lat== -21.1819)
# ptw.unique<-ptw.unique[-45,]
# which(ptw.unique$lon == 55.4539, ptw.unique$lat== -20.8739)
# ptw.unique<-ptw.unique[-1082,]

# only complete cases
ptw.unique<-ptw.unique[complete.cases(ptw.unique),]
dim(ptw.unique)

#remove all the florida points
ptw_unique_with_florida <- ptw.unique
plot(wrld_simpl)
points(ptw_unique_with_florida, cex = .2, col = "red")

write.csv(ptw_unique_with_florida, file = "ptw.unique.with.florida.qgis.csv")

####################################################################################################
#################################################   spThin    ######################################
#####################################################################################################
setwd("~/Desktop/Whydah Project/whydah/Data")
# set coordinate system
crs <- CRS('+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs')
# then thin
thin_ptw_with_florida <-spThin(
  ptw_unique_with_florida, 
  x.col = "lon",
  y.col = "lat",
  dist = 3000,
  method= "gurobi", #can change to "gurobi" to make it even faster, but have to install it first
  great.circle.distance=TRUE)
summary(thin_ptw_with_florida)

# Saving the thinned file ####
# print temporary dir
print(tempdir())
write.SpThin(
  thin_ptw_with_florida,
  coords=FALSE,
  dir=tempdir()
)

# Read in .csv of all thinned points
thin_ptw_with_florida_2<-read.csv("thin_0001.csv", head=T)
head(thin_ptw_with_florida_2)
thin_ptw_with_florida_coords<-thin_ptw_with_florida_2[,1:2]
write.csv(thin_ptw_with_florida_coords, file = "ptw.thinned.with.floridafor.figure1.csv")

####################################################################################################
################################   Orange-cheeked Occurrences   ####################################
####################################################################################################

setwd("~/Desktop/Whydah Project/whydah/Data") #set back to data directory

# ocw<-gbif('Estrilda', 'melpoda', geo=T, removeZeros = T)
# save(ocw, file="ocw.rdata")
load("ocw.rdata")
head(ocw)
dim(ocw)

ocw<-ocw[,c('lon','lat','country','species')]
ocw<-subset(ocw, !is.na(lat) & !is.na(lon))
head(ocw)
ocw.unique<- distinct(select(ocw,lon,lat,country,species)) #remove duplicates
dim(ocw.unique)
head(ocw.unique)

# Removing outliers by country
plot(wrld_simpl)
points(ocw.unique, col="red")

unique(ocw.unique$country)
ocw.unique<-filter(ocw.unique, country !="Canada") #Remove Canada
ocw.unique<-filter(ocw.unique, country !="Germany") #Remove Germany
unique(ocw.unique$country)

# Remove outliers by lon/lat
filter(ocw.unique, lon>(-100) & lon<(-89) & country=="United States") #find northern midwest point
which(ocw.unique$lon == -95.55926, ocw.unique$lat== 29.69430) #find it in the data.frame
ocw.unique<- ocw.unique[-407,] #remove that row!

filter(ocw.unique, lon>(-100) & lon<(-89) & country=="United States") #find 2nd midwest points
points(-96.67213,40.80549,col="green") #make sure it's the right one
which(ocw.unique$lon == -96.67213, ocw.unique$lat== 40.80549) #find it in the data.frame
ocw.unique<- ocw.unique[-1031,] #remove that row!

filter(ocw.unique, lon>(-100) & lon<(-89) & country=="United States") #find 3rd midwest points
points(-96.67964,40.80004,col="purple") #make sure it's the right one
which(ocw.unique$lon == -96.67964, ocw.unique$lat== 40.80004) #find it in the data.frame
ocw.unique<- ocw.unique[-1084,] #remove that row!

filter(ocw.unique, lon>(-87) & lat>(36) & country=="United States") #find DC point
points(-77.09590,38.75890,col="purple") #make sure it's the right one
which(ocw.unique$lon == -77.09590, ocw.unique$lat== 38.75890) #find it in the data.frame
ocw.unique<- ocw.unique[-607,] #remove that row!

points(-77.10650,38.75890,col="green") #make sure it's the right one
which(ocw.unique$lon == -77.10650, ocw.unique$lat== 38.75890) #find it in the data.frame
ocw.unique<- ocw.unique[-611,] #remove that row!

points(-83.14313,42.47483,col="green") #make sure it's the right one
which(ocw.unique$lon == -83.14313, ocw.unique$lat== 42.47483) #find it in the data.frame
ocw.unique<- ocw.unique[-958,] #remove that row!

## Hawaii Points
hawaii_ocw_points <- which(ocw.unique$lon<(-154) & ocw.unique$lat>18 & ocw.unique$country=="United States")
hawaii_ocw_points
ocw.unique<-ocw.unique[-hawaii_ocw_points,] #remove san fran point

# Find 2nd San Fran point
which(ocw.unique$lat == 41.96554)
ocw.unique<-ocw.unique[-1018,] #remove san fran point

# Re-check ocw points
plot(wrld_simpl)
points(ocw.unique,col="red")

# Complete cases
ocw.unique<-ocw.unique[complete.cases(ocw.unique),]
dim(ocw.unique)

# OCW Thinning ####
setwd("~/Desktop/Whydah Project/whydah/Output")
crs <- CRS('+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs')

thin_ocw <-spThin(
  ocw.unique, 
  x.col = "lon",
  y.col = "lat",
  dist = 3000,
  method= "gurobi",
  great.circle.distance=TRUE)
summary(thin_ocw)
str(thin_ocw)
plot(thin_ocw)

# Save thinned file
print(tempdir())
write.SpThin(
  thin_ocw,
  coords=FALSE,
  dir=tempdir()
)

# Read in .csv of thinned points
thin_ocw2<-read.csv("thin_0001.csv", head=T)
head(thin_ocw2) #Always check to make sure this shows correct species

####################################################################################################
##############################   Common Waxbill Occurrences   ######################################
####################################################################################################

setwd("~/Desktop/Whydah Project/whydah/Data") #back to data directory
# cw<-gbif('Estrilda', 'astrild', geo=T, removeZeros = T)
# save(cw, file="cw.rdata")
load("cw.rdata")
head(cw)
dim(cw)

# Removing outliers by country

cw<-filter(cw, country !="Canada")#Remove Canada
cw<-filter(cw, country !="United Arab Emirates") #remove UAE (listed as escapes)
unique(cw$country)
cw<-subset(cw, basisOfRecord == "HUMAN_OBSERVATION")

### South Africa Points ##
cw_south_africa<-subset(cw, country == "South Africa")
dim(cw_south_africa)
head(cw_south_africa)
count(cw_south_africa$collectionCode)

rows_to_save_cw <- which(cw_south_africa$collectionCode == "EBIRD" | 
                           cw_south_africa$collectionCode == "EBIRD_AU" | 
                           cw_south_africa$collectionCode == "EBIRD_CAN" | 
                           cw_south_africa$collectionCode == "naturgucker" | 
                           cw_south_africa$collectionCode == "Observations" | 
                           cw_south_africa$collectionCode == "SAFRING")

cw_south_africa_no_transects <- cw_south_africa[rows_to_save_cw, ] 
table(cw_south_africa_no_transects$collectionCode)

write.csv(cw_south_africa_no_transects, file = "cw_south_africa_no_transects.csv")
plot(wrld_simpl)
points(cw_south_africa_no_transects)

## Remove ALL South African Points
cw_no_south_africa <- filter(cw, country !="South Africa")

# Merge with our much better SA whydah points
dim(cw_no_south_africa)
dim(cw_south_africa)
new_cw <- rbind(cw_no_south_africa, cw_south_africa)
dim(new_cw)

new_cw<-subset(new_cw, !is.na(lat) & !is.na(lon))
new_cw_unique<- distinct(select(new_cw,lon,lat,country,species)) #remove duplicates
dim(new_cw_unique)

# Remove outliers by lon/lat
filter(new_cw_unique, lon<(-72) & lat>(35)) #find northern midwest point
points(-77.22568,38.97612)
which(cw$lon == -77.22568, cw$lat== 38.97612) #find it in the data.frame
#cw.unique<- cw.unique[-5,] #remove that row!

# Check Common Waxbill Points
plot(wrld_simpl)
points(new_cw_unique, col="red")

# Thin Common Waxbill
setwd("~/Desktop/Whydah Project/whydah/Output")
crs <- CRS('+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs')

dim(new_cw_unique)
thin_cw <-spThin(
  new_cw_unique, 
  x.col = "lon",
  y.col = "lat",
  dist = 3000,
  method= "gurobi",
  great.circle.distance=TRUE)
summary(thin_cw)

# Save thinned file
print(tempdir())
write.SpThin(
  thin_cw,
  coords=FALSE,
  dir=tempdir()
)

# Read .csv of  thinned points
thin_cw2<-read.csv("thin_0001.csv", head=T)
head(thin_cw2)

####################################################################################################
#############################   Bronze Mannikin Occurrences   ######################################
####################################################################################################

setwd("~/Desktop/Whydah Project/whydah/Data")
# bronze <- gbif('Spermestes', 'cucullata', geo = T, removeZeros = T)
# save(bronze, file="bronze.rdata")
load("bronze.rdata")
write.csv(bronze, "bronze_full_set.csv")
head(bronze)
names(bronze$basisOfRecord)
bronze<-subset(bronze, basisOfRecord == "HUMAN_OBSERVATION")

### South Africa Points ##
bronze_south_africa<-subset(bronze, country == "South Africa")
dim(bronze_south_africa)
head(bronze_south_africa)
count(bronze_south_africa$collectionCode)

rows_to_save_bronze <- which(bronze_south_africa$collectionCode == "EBIRD" | 
                                 bronze_south_africa$collectionCode == "EBIRD_AU" | 
                                 bronze_south_africa$collectionCode == "EBIRD_CAN" | 
                                 bronze_south_africa$collectionCode == "naturgucker" | 
                                 bronze_south_africa$collectionCode == "Observations" | 
                                 bronze_south_africa$collectionCode == "SAFRING")

bronze_south_africa_no_transects <- bronze_south_africa[rows_to_save_bronze, ] 
table(bronze_south_africa_no_transects$collectionCode)

write.csv(bronze_south_africa_no_transects, file = "bronze_south_africa_no_transects.csv")
plot(wrld_simpl)
points(bronze_south_africa_no_transects)

## Remove ALL South African Points
bronze_no_south_africa <- filter(bronze, country !="South Africa")

# Merge with our much better SA whydah points
dim(bronze_no_south_africa)
dim(bronze_south_africa_no_transects)
new_bronze <- rbind(bronze_no_south_africa, bronze_south_africa_no_transects)
dim(new_bronze)

new_bronze<-new_bronze[,c('lon','lat','country','species')]
new_bronze<-subset(new_bronze, !is.na(lat) & !is.na(lon))
head(new_bronze)
new_bronze_unique<- distinct(select(new_bronze,lon,lat,country,species)) #remove duplicates

thin_bronze <-spThin(
  new_bronze_unique, 
  x.col = "lon",
  y.col = "lat",
  dist = 3000,
  method= "gurobi",
  great.circle.distance=TRUE)
summary(thin_bronze)

# Save thinned file
print(tempdir())
write.SpThin(
  thin_bronze,
  coords=FALSE,
  dir=tempdir()
)

# Read .csv of all thinned points
thin_bronze2<-read.csv("thin_0001.csv", head=T)
head(thin_bronze2) #Always check to make sure this shows correct species
dim(thin_bronze2)
write.csv(thin_bronze2, "bronze_thinned.csv")

####################################################################################################
#####################################   Nutmeg Mannikin   ##########################################
####################################################################################################

setwd("~/Desktop/Whydah Project/whydah/Data")
# nutmeg<-gbif('Lonchura', 'punctulata', geo=T, removeZeros = T)
# save(nutmeg, file="nutmeg.rdata")
load("nutmeg.rdata")
nutmeg<-nutmeg[,c('lon','lat','country','species')]
nutmeg<-subset(nutmeg, !is.na(lat) & !is.na(lon))
head(nutmeg)
nutmeg.unique<- distinct(select(nutmeg,lon,lat,country,species)) #remove duplicates
dim(nutmeg.unique)
head(nutmeg.unique)

# Remove outliers by country
plot(wrld_simpl)
points(nutmeg.unique, col="red")

unique(nutmeg.unique$country)
nutmeg.unique<-filter(nutmeg.unique, country !="Canada") #Remove Canada
nutmeg.unique<-filter(nutmeg.unique, country !="Honduras") #Remove Honduras
unique(nutmeg.unique$country)

# Remove outliers by lon/lat...for nutmegs these include museum speciments and acoustic labs in US
points(-94, 38, col='green') #This is acoustic lab point
which(nutmeg.unique$lon == -94, nutmeg.unique$lat== 38) #find it in the data.frame
nutmeg.unique<- nutmeg.unique[-9196,] #remove that row!

filter(nutmeg.unique, lon>(-90) & lat>(40) & country=="United States") #find midwest points
points(-83.13383, 42.68063,col="green") #make sure it's the right one
which(nutmeg.unique$lon == -83.13383, nutmeg.unique$lat== 42.68063) #find it in the data.frame
nutmeg.unique<- nutmeg.unique[-7926,] #remove that row!
points(-83.72634, 42.27084,col="green") #make sure it's the right one
which(nutmeg.unique$lon == -83.72634, nutmeg.unique$lat== 42.27084) #find it in the data.frame
nutmeg.unique<- nutmeg.unique[-8706,] #remove that row!

filter(nutmeg.unique, lon>(-90) & lat>(38) & country=="United States") #last midwest point
points(-83.0189, 39.9961,col="green")
which(nutmeg.unique$lon == -83.0189, nutmeg.unique$lat== 39.9961) #find it in the data.frame
nutmeg.unique<- nutmeg.unique[-8952,] #remove that row!

# Re-check points for more outliers
plot(wrld_simpl)
points(nutmeg.unique, col="red")

# Complete cases
nutmeg.unique<-nutmeg.unique[complete.cases(nutmeg.unique),]
dim(nutmeg.unique)

# Thin Nutmeg
setwd("~/Desktop/Whydah Project/whydah/Output")
crs <- CRS('+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs')

thin_nutmeg <-spThin(
  nutmeg.unique, 
  x.col = "lon",
  y.col = "lat",
  dist = 3000,
  method= "gurobi",
  great.circle.distance=TRUE)
summary(thin_nutmeg)
str(thin_nutmeg)
plot(thin_nutmeg)

# Save thinned file
print(tempdir())
write.SpThin(
  thin_nutmeg,
  coords=FALSE,
  dir=tempdir()
)

# Read .csv of thinned points
thin_nutmeg2<-read.csv("thin_0001.csv", head=T)
head(thin_nutmeg2) #Always check to make sure this shows correct species
write.csv(thin_nutmeg2, "nutmeg_thinned.csv")

####################################################################################################
################################   Black-rumped Waxbill Occs   ######################################
####################################################################################################

setwd("~/Desktop/Whydah Project/whydah/Data")
# black_rumped_waxbill <- gbif('Estrilda', 'troglodytes', geo = T, removeZeros = T)
# save(black_rumped_waxbill, file="black_rumped_waxbill.rdata")
load("black_rumped_waxbill.rdata")
black_rumped_waxbill<-black_rumped_waxbill[,c('lon','lat','country','species')]
black_rumped_waxbill<-subset(black_rumped_waxbill, !is.na(lat) & !is.na(lon))
head(black_rumped_waxbill)
black_rumped_waxbill.unique<- distinct(select(black_rumped_waxbill,lon,lat,country,species)) #remove duplicates
dim(black_rumped_waxbill.unique)
head(black_rumped_waxbill.unique)

# Remove outliers by country
plot(wrld_simpl)
points(black_rumped_waxbill.unique, col="red")

unique(black_rumped_waxbill.unique$country)
black_rumped_waxbill.unique<-filter(black_rumped_waxbill.unique, country !="Canada") #Remove Canada
unique(black_rumped_waxbill.unique$country)

# Remove outliers by lon/lat...for nutmegs these include museum speciments and acoustic labs in US
filter(black_rumped_waxbill.unique, lon>(-84) & lat>(40) & country=="United States")
points(-83.14313, 42.47483,col="green")
which(black_rumped_waxbill.unique$lon == -83.14313, black_rumped_waxbill.unique$lat== 42.47483) #find it in the data.frame
black_rumped_waxbill.unique<- black_rumped_waxbill.unique[-222,] #remove that row!

hawaii_black_rumped_points <- which(black_rumped_waxbill.unique$lon<(-154) & black_rumped_waxbill.unique$lat>18 & black_rumped_waxbill.unique$country=="United States")
hawaii_black_rumped_points
black_rumped_waxbill.unique<-black_rumped_waxbill.unique[-hawaii_black_rumped_points,] #remove san fran point

single_bwwb <- which(black_rumped_waxbill.unique$lon<(-145) & black_rumped_waxbill.unique$lat<18)
single_bwwb
black_rumped_waxbill.unique<-black_rumped_waxbill.unique[-single_bwwb,] #remove san fran point


# Re-check points for more outliers
plot(wrld_simpl)
points(black_rumped_waxbill.unique, col="red")

# Complete cases
black_rumped_waxbill.unique<-black_rumped_waxbill.unique[complete.cases(black_rumped_waxbill.unique),]
dim(black_rumped_waxbill.unique)

# Thin Nutmeg
setwd("~/Desktop/Whydah Project/whydah/Output")
crs <- CRS('+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs')

thin_black_rumped_waxbill <-spThin(
  black_rumped_waxbill.unique, 
  x.col = "lon",
  y.col = "lat",
  dist = 3000,
  method= "gurobi",
  great.circle.distance=TRUE)
summary(thin_black_rumped_waxbill)
str(thin_black_rumped_waxbill)
plot(thin_black_rumped_waxbill)

# Save thinned file
print(tempdir())
write.SpThin(
  thin_black_rumped_waxbill,
  coords=FALSE,
  dir=tempdir()
)

# Read .csv of thinned points
thin_black_rumped_waxbill2<-read.csv("thin_0001.csv", head=T)
head(thin_black_rumped_waxbill2) #Always check to make sure this shows correct species
dim(thin_black_rumped_waxbill2)
####################################################################################################
################################   African Silverbill Occs   #######################################
####################################################################################################

setwd("~/Desktop/Whydah Project/whydah/Data")
# african_silverbill <- gbif('Euodice', 'cantans', geo = T, removeZeros = T)
# save(african_silverbill, file="african_silverbill.rdata")
load("african_silverbill.rdata")
silverbill<-african_silverbill
silverbill<-silverbill[,c('lon','lat','country','species')]
silverbill<-subset(silverbill, !is.na(lat) & !is.na(lon))
head(silverbill)
silverbill.unique<- distinct(select(silverbill,lon,lat,country,species)) #remove duplicates
dim(silverbill.unique)
head(silverbill.unique)

# Remove outliers by country
plot(wrld_simpl)
points(silverbill.unique, col="red")

# Complete cases
silverbill.unique<-silverbill.unique[complete.cases(silverbill.unique),]
dim(silverbill.unique)

# Thin Nutmeg
setwd("~/Desktop/Whydah Project/whydah/Output")
crs <- CRS('+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs')

thin_silverbill <-spThin(
  silverbill.unique, 
  x.col = "lon",
  y.col = "lat",
  dist = 3000,
  method= "gurobi",
  great.circle.distance=TRUE)
summary(thin_silverbill)
str(thin_silverbill)
plot(thin_silverbill)

# Save thinned file
print(tempdir())
write.SpThin(
  thin_silverbill,
  coords=FALSE,
  dir=tempdir()
)

# Read .csv of thinned points
thin_silverbill2<-read.csv("thin_0001.csv", head=T)
head(thin_silverbill2) #Always check to make sure this shows correct species

####################################################################################################
################################   Presence/Absence Rasters   ######################################
####################################################################################################

# Function for Presence/Absence Rasters for Host Species by Amy Whitehead
presence.absence.raster <- function (mask.raster,species.data,raster.label="") {
  require(raster)
  
  # set the background cells in the raster to 0
  mask.raster[!is.na(mask.raster)] <- 0
  
  #set the cells that contain points to 1
  speciesRaster <- rasterize(species.data,mask.raster,field=1)
  speciesRaster <- merge(speciesRaster,mask.raster)
  
  #label the raster
  names(speciesRaster) <- raster.label
  return(speciesRaster)
}

setwd("~/Desktop/Whydah Project/whydah/Data/wc5")

# P/A Raster for Common Waxbill
species <- "Common Waxbill"
thin_cw2<-thin_cw2[,1:2] #prepare only lat/lon data for pres/absence
myRaster <- raster( "bio1.bil") #resolution of 5 second is .08333x.08333, or 10km grid cells. resolution of 2 second is .04166 x .04166
# create presence absence raster for Common Waxbills using pre-made function
pa_raster_cw <- presence.absence.raster(mask.raster=myRaster, species.data=thin_cw2, raster.label=species)
pa_raster_cw

# P/A Raster for Orange-Cheeked Waxbill
species <- "OrangeCheekedWaxbill"
thin_ocw2<-thin_ocw2[,1:2] #prepare only lat/lon data for pres/absence
# read in a raster of the world
myRaster <- raster( "bio1.bil")
pa_raster_ocw <- presence.absence.raster(mask.raster=myRaster, species.data=thin_ocw2, raster.label=species)
pa_raster_ocw

# P/A Raster for Nutmeg
species <- "Nutmeg Mannikin"
thin_nutmeg2<-thin_nutmeg2[,1:2] #prepare only lat/lon data for pres/absence
myRaster <- raster( "bio1.bil")
pa_raster_nutmeg <- presence.absence.raster(mask.raster=myRaster, species.data=thin_nutmeg2, raster.label=species)
pa_raster_nutmeg

# P/A Raster for Bronze Mannikin
species <- "Bronze Mannikin"
thin_bronze2<-thin_bronze2[,1:2] #prepare only lat/lon data for pres/absence
myRaster <- raster( "bio1.bil") #resolution of 5 second is .08333x.08333, or 10km grid cells. resolution of 2 second is .04166 x .04166
pa_raster_bronze <- presence.absence.raster(mask.raster=myRaster, species.data=thin_bronze2, raster.label=species)
pa_raster_bronze

# P/A Raster for Black-rumped
species <- "Black-rumped"
thin_black_rumped_waxbill2<-thin_black_rumped_waxbill2[,1:2] #prepare only lat/lon data for pres/absence
myRaster <- raster( "bio1.bil") #resolution of 5 second is .08333x.08333, or 10km grid cells. resolution of 2 second is .04166 x .04166
pa_raster_black_rumped_waxbill <- presence.absence.raster(mask.raster=myRaster, species.data=thin_black_rumped_waxbill2, raster.label=species)
pa_raster_black_rumped_waxbill

# P/A Raster for Silverbill
species <- "Silverbill"
thin_silverbill2<-thin_silverbill2[,1:2] #prepare only lat/lon data for pres/absence
myRaster <- raster( "bio1.bil") #resolution of 5 second is .08333x.08333, or 10km grid cells. resolution of 2 second is .04166 x .04166
pa_raster_silverbill <- presence.absence.raster(mask.raster=myRaster, species.data=thin_silverbill2, raster.label=species)
pa_raster_silverbill

####################################################################################################
################################   Preparing Predictor Variables ###################################
####################################################################################################

setwd("~/Desktop/Whydah Project/whydah/Data")

#LULC Layer
LULC_layer <- readGDAL("LULC_Resampled.tif")
LULC_raster <- raster(LULC_layer)
plot(LULC_raster)

LULC_layer_world_map <- readGDAL("LULC_Resampled_clipped_world_map.tif")
LULC_layer_world_map_raster <- raster(LULC_layer_world_map)
plot(LULC_layer_world_map_raster)

# get the file names...these should be all of our our worldclim
files <- list.files(path="~/Desktop/Whydah Project/whydah/Data/wc5", pattern="bil", full.names=TRUE)
files

# stack predictors
climate <- stack(files)
names(climate)

res(climate[[1]])
extent(climate[[1]])
hosts <- stack(pa_raster_cw,pa_raster_ocw,pa_raster_nutmeg,pa_raster_bronze,pa_raster_black_rumped_waxbill,pa_raster_silverbill)
names(hosts)

LULC <- stack(LULC_raster)
names(LULC)

hosts_and_habitat <- stack(LULC_raster, pa_raster_cw,pa_raster_ocw,pa_raster_nutmeg,pa_raster_bronze,pa_raster_black_rumped_waxbill,pa_raster_silverbill)
names(hosts_and_habitat)

LULC_world_map <- stack(LULC_layer_world_map_raster)
names(LULC_world_map)

climate_and_hosts <- stack(files, pa_raster_cw,pa_raster_ocw,pa_raster_nutmeg,pa_raster_bronze,pa_raster_black_rumped_waxbill,pa_raster_silverbill)
names(climate_and_hosts)

climate_and_LULC <- stack(files, LULC_raster)
names(climate_and_LULC)

climate_and_hosts_and_LULC <- stack(climate_and_hosts, LULC_raster)
names(climate_and_hosts_and_LULC)

####################################################################################################
########################### Background points from five degree buffer ##############################
####################################################################################################
setwd('/Users/rpecchia/Desktop/Whydah Project/whydah/Data')

whydah_occurrences_spdf <- SpatialPointsDataFrame(coords = thin_ptw_with_florida_coords, data = thin_ptw2_coords,
                                                  proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))

writeOGR(whydah_occurrences_spdf, dsn = ".",layer = "whydah_csv_spdf_as_shp", driver = "ESRI Shapefile")

#now read in the file w/ buffers from QGIS
buffered_region_florida <- readGDAL("ptw_with_florida_buffers_2_cropped.tif")

#convert buffered region to raster
buffer_florida_raster <- raster(buffered_region_florida) #convert africa map to raster
backg_with_florida <- randomPoints(buffer_florida_raster, n=10000)

plot(wrld_simpl)
points(backg_with_florida, col = "purple", cex = 0.2)

####################################################################################################
######################################### MaxEnt for Climate #######################################
####################################################################################################

mx_climate_florida <- maxent(climate, thin_ptw_with_florida_coords, a=backg_with_florida, 
                             args=c('responsecurves=TRUE', 
                                    'replicatetype=crossvalidate', 'replicates=5',
                                    'writebackgroundpredictions=TRUE','outputgrids=TRUE'))
mx_climate_florida@results

# Full occurrence set
mx_climate_full_florida <- maxent(climate, thin_ptw_with_florida_coords, a=backg_with_florida, 
                                  args=c('responsecurves=TRUE',
                                         'writebackgroundpredictions=TRUE'))
mx_climate_full_florida@results

# response(mx_no_host_all_occs)
plot(mx_climate_full_florida)
mx_climate_full_florida@results
mx_climate_full_florida@lambdas

px_climate_full_florida <- predict(climate, mx_climate_full_florida, progress='text') #make predictions of habitat suitability can include argument ext=ext
plot(px_climate_full_florida, main= 'Maxent, raw values')

# Forming Confusion Matrix
training_suitability_climate <-extract(px_climate_full_florida, thin_ptw_with_florida_coords) # extract predicted values, at known presence points
training_suitability_climate<-na.omit(training_suitability_climate)
ten_thresh_climate <- quantile(training_suitability_climate, 0.1, na.rm = TRUE)
ten_thresh_climate

pred_binary_climate <- training_suitability_climate > ten_thresh_climate #where are known presence greater than threshold?
length(pred_binary_climate[pred_binary_climate==TRUE]) # these are "a" the true positives
length(pred_binary_climate[pred_binary_climate==FALSE]) #these are "c" the false negatives

background_suitability_climate <- extract(px_climate_full_florida, backg_with_florida)
pred_binary_background_climate <- background_suitability_climate > ten_thresh_climate

length(pred_binary_background_climate[pred_binary_background_climate==TRUE]) #these are "b" the false pos
length(pred_binary_background_climate[pred_binary_background_climate==FALSE]) # these are "d" the true neg 

####################################################################################################
####################################### MaxEnt for Hosts ##########################################
####################################################################################################

# k-fold
names(hosts)
mx_hosts_florida <- maxent(hosts, thin_ptw_with_florida_coords, a=backg_with_florida, 
                           args=c('responsecurves=TRUE', 
                                  'replicatetype=crossvalidate', 'replicates=5',
                                  'writebackgroundpredictions=TRUE','outputgrids=TRUE'))
mx_hosts_florida@results

# all occurrences
mx_hosts_model_full_florida <- maxent(hosts, thin_ptw_with_florida_coords, a=backg_with_florida, 
                                      args=c('responsecurves=TRUE',
                                             'writebackgroundpredictions=TRUE'))

mx_hosts_model_full_florida@results
response(mx_hosts_model_full_florida)
plot(mx_hosts_model_full_florida)
dim(thin_ptw_with_florida_coords)
px_hosts_model <- predict(hosts, mx_hosts_model_full_florida, progress='text') #make predictions of habitat suitability can include argument ext=ext
plot(px_hosts_model, main= 'Maxent, raw values')
writeRaster(px_hosts_model, filename="hosts_model_for_qgis.tif", format="GTiff", overwrite=TRUE) #exporting a GEOtiff

# 10% Min. Training Pres Threshold
training_suitability_hosts_model <- extract(px_hosts_model, thin_ptw_with_florida_coords) #all predicted values, all occs
training_suitability_hosts_model <- na.omit(training_suitability_hosts)
ten_thresh_hosts_model <- quantile(training_suitability_hosts, 0.1, na.rm = TRUE)
ten_thresh_hosts_model
###
ten_thresh_hosts_model <- .036

# Confusion Matrix
training_suitability_hosts_2 <- extract(px_hosts_model, thin_ptw_with_florida_coords) # extract predicted values, at known presence points
training_suitability_hosts_2 <- na.omit(training_suitability_hosts_2)
pred_binary_hosts <- training_suitability_hosts_2 > ten_thresh_hosts_model #where are known presence greater than threshold?
length(pred_binary_hosts[pred_binary_hosts==TRUE]) # these are "a" the true positives
length(pred_binary_hosts[pred_binary_hosts==FALSE]) #these are "c" the false negatives

background_suitability_hosts <- extract(px_hosts_model, backg_with_florida)
pred_binary_background_hosts <- background_suitability_hosts > ten_thresh_hosts_model

length(pred_binary_background_hosts[pred_binary_background_hosts==TRUE]) #these are "b" the false pos
length(pred_binary_background_hosts[pred_binary_background_hosts==FALSE]) # these are "d" the true neg 

####################################################################################################
################################### MaxEnt for LULC ########################################
####################################################################################################
# k-fold
names(LULC)
mx_LULC_model_florida <- maxent(LULC, thin_ptw_with_florida_coords, a=backg_with_florida, factors = "band1",
                                            args=c('responsecurves=TRUE', 
                                                   'replicatetype=crossvalidate', 'replicates=5',
                                                   'writebackgroundpredictions=TRUE','outputgrids=TRUE'))
mx_LULC_model_florida@results

# all occurrences
mx_LULC_model_full_florida <- maxent(LULC, thin_ptw_with_florida_coords, a=backg_with_florida, factors = "band1",
                                                 args=c('responsecurves=TRUE',
                                                        'writebackgroundpredictions=TRUE'))

response(mx_LULC_model_full_florida)
mx_LULC_model_full_florida@results
mx_LULC_model_full_florida@path

px_LULC_model_full_occurrences <- predict(LULC, mx_LULC_model_full_florida, progress='text') #make predictions of habitat suitability can include argument ext=ext
plot(px_LULC_model_full_occurrences, main= 'Maxent, raw values')
writeRaster(px_LULC_model_full_occurrences, filename="LULC_model_for_qgis.tif", format="GTiff", overwrite=TRUE) #exporting a GEOtiff

# 10% Min. Training Pres Threshold
training_suitability_LULC <- extract(px_LULC_model_full_occurrences, thin_ptw_with_florida_coords) #all predicted values, all occs
training_suitability_LULC <- na.omit(training_suitability_LULC)
ten_thresh_LULC <- quantile(training_suitability_LULC, 0.1, na.rm = TRUE)
ten_thresh_LULC

# Confusion Matrix
training_suitability_LULC <- extract(px_LULC_model_full_occurrences, thin_ptw_with_florida_coords) # extract predicted values, at known presence points
training_suitability_LULC <- na.omit(training_suitability_LULC)
pred_binary_LULC <- training_suitability_LULC > ten_thresh_LULC #where are known presence greater than threshold?
length(pred_binary_LULC[pred_binary_LULC==TRUE]) # these are "a" the true positives
length(pred_binary_LULC[pred_binary_LULC==FALSE]) #these are "c" the false negatives

background_suitability_LULC <- extract(px_LULC_model_full_occurrences, backg_with_florida)
pred_binary_background_LULC <- background_suitability_LULC > ten_thresh_LULC

length(pred_binary_background_LULC[pred_binary_background_LULC==TRUE]) #these are "b" the false pos
length(pred_binary_background_LULC[pred_binary_background_LULC==FALSE]) # these are "d" the true neg 
####################################################################################################
################################### MaxEnt for Climate & Hosts ########################################
####################################################################################################
# k-fold
mx_climate_and_hosts_florida <- maxent(climate_and_hosts, thin_ptw_with_florida_coords, a=backg_with_florida, 
                                       args=c('responsecurves=TRUE', 
                                              'replicatetype=crossvalidate', 'replicates=5',
                                              'writebackgroundpredictions=TRUE','outputgrids=TRUE'))
mx_climate_and_hosts_florida@results

# all occurrences
mx_climate_and_hosts_full_florida <- maxent(climate_and_hosts, thin_ptw_with_florida_coords, a=backg_with_florida, 
                                            args=c('responsecurves=TRUE',
                                                   'writebackgroundpredictions=TRUE'))
plot(mx_climate_and_hosts_full_florida)
mx_climate_and_hosts_full_florida@results
mx_climate_and_hosts_full_florida@lambdas

px_climate_and_hosts <- predict(climate_and_hosts, mx_climate_and_hosts_full_florida, progress='text') #make predictions of habitat suitability can include argument ext=ext
plot(px_climate_and_hosts, main= 'Maxent, raw values')
writeRaster(px_climate_and_hosts, filename="climate_and_hosts_for_qgis.tif", format="GTiff", overwrite=TRUE) #exporting a GEOtiff

# 10% Min. Training Pres Threshold
training_suitability_climate_and_hosts <- extract(px_climate_and_hosts, thin_ptw_with_florida_coords) #all predicted values, all occs
training_suitability_climate_and_hosts <- na.omit(training_suitability_climate_and_hosts)
ten_thresh_climate_and_hosts <- quantile(training_suitability_climate_and_hosts, 0.1, na.rm = TRUE)
ten_thresh_climate_and_hosts

# Confusion Matrix
training_suitability_climate_and_hosts <- extract(px_climate_and_hosts, thin_ptw_with_florida_coords) # extract predicted values, at known presence points
training_suitability_climate_and_hosts <- na.omit(training_suitability_climate_and_hosts)
pred_binary_climate_and_hosts <- training_suitability_climate_and_hosts > ten_thresh_climate_and_hosts #where are known presence greater than threshold?
length(pred_binary_climate_and_hosts[pred_binary_climate_and_hosts==TRUE]) # these are "a" the true positives
length(pred_binary_climate_and_hosts[pred_binary_climate_and_hosts==FALSE]) #these are "c" the false negatives

background_suitability_climate_and_hosts <- extract(px_climate_and_hosts, backg_with_florida)
pred_binary_background_climate_and_hosts <- background_suitability_climate_and_hosts > ten_thresh_climate_and_hosts

length(pred_binary_background_climate_and_hosts[pred_binary_background_climate_and_hosts==TRUE]) #these are "b" the false pos
length(pred_binary_background_climate_and_hosts[pred_binary_background_climate_and_hosts==FALSE]) # these are "d" the true neg 

####################################################################################################
################################### MaxEnt for Climate & LULC ########################################
####################################################################################################

# k-fold
mx_climate_and_LULC_model_florida <- maxent(climate_and_LULC, thin_ptw_with_florida_coords, a=backg_with_florida, factors = "band1", 
                                            args=c('responsecurves=TRUE', 
                                                   'replicatetype=crossvalidate', 'replicates=5',
                                                   'writebackgroundpredictions=TRUE','outputgrids=TRUE'))

mx_climate_and_LULC_model_florida@results

# all occurrences
mx_climate_and_LULC_model_full_florida <- maxent(climate_and_LULC, thin_ptw_with_florida_coords, a=backg_with_florida, factors = "band1",
                                                 args=c('responsecurves=TRUE',
                                                        'writebackgroundpredictions=TRUE'))
plot(mx_climate_and_LULC_model_full_florida)
mx_climate_and_LULC_model_full_florida@results
mx_climate_and_LULC_model_full_florida@lambdas

px_climate_and_LULC_model <- predict(climate_and_LULC, mx_climate_and_LULC_model_full_florida, progress='text') #make predictions of habitat suitability can include argument ext=ext
plot(px_climate_and_LULC_model, main= 'Maxent, raw values')
writeRaster(px_climate_and_LULC_model, filename="climate_and_LULC_for_qgis.tif", format="GTiff", overwrite=TRUE) #exporting a GEOtiff

# 10% Min. Training Pres Threshold
training_suitability_climate_and_LULC <- extract(px_climate_and_LULC_model, thin_ptw_with_florida_coords) #all predicted values, all occs
training_suitability_climate_and_LULC <- na.omit(training_suitability_climate_and_LULC)
ten_thresh_climate_and_LULC <- quantile(training_suitability_climate_and_LULC, 0.1, na.rm = TRUE)
ten_thresh_climate_and_LULC

# Confusion Matrix
training_suitability_climate_and_LULC <- extract(px_climate_and_LULC_model, thin_ptw_with_florida_coords) # extract predicted values, at known presence points
training_suitability_climate_and_LULC <- na.omit(training_suitability_climate_and_LULC)
pred_binary_climate_and_LULC <- training_suitability_climate_and_LULC > ten_thresh_climate_and_LULC #where are known presence greater than threshold?
length(pred_binary_climate_and_LULC[pred_binary_climate_and_LULC==TRUE]) # these are "a" the true positives
length(pred_binary_climate_and_LULC[pred_binary_climate_and_LULC==FALSE]) #these are "c" the false negatives

background_suitability_climate_and_LULC <- extract(px_climate_and_LULC_model, backg_with_florida)
pred_binary_background_climate_and_LULC <- background_suitability_climate_and_LULC > ten_thresh_climate_and_LULC

length(pred_binary_background_climate_and_LULC[pred_binary_background_climate_and_LULC==TRUE]) #these are "b" the false pos
length(pred_binary_background_climate_and_LULC[pred_binary_background_climate_and_LULC==FALSE]) # these are "d" the true neg 

####################################################################################################
################################### MaxEnt for Hosts & Habitat ########################################
####################################################################################################

# k-fold
names(hosts_and_habitat)
mx_hosts_and_habitat <- maxent(hosts_and_habitat, thin_ptw_with_florida_coords, a=backg_with_florida, factors = "band1", 
                                            args=c('responsecurves=TRUE', 
                                                   'replicatetype=crossvalidate', 'replicates=5',
                                                   'writebackgroundpredictions=TRUE','outputgrids=TRUE'))

mx_hosts_and_habitat@results

# all occurrences
mx_hosts_and_habitat_full <- maxent(hosts_and_habitat, thin_ptw_with_florida_coords, a=backg_with_florida, factors = "band1",
                                                 args=c('responsecurves=TRUE',
                                                        'writebackgroundpredictions=TRUE'))
plot(mx_hosts_and_habitat_full)
mx_hosts_and_habitat_full@results
mx_hosts_and_habitat_full@lambdas

px_hosts_and_habitat <- predict(hosts_and_habitat, mx_hosts_and_habitat_full, progress='text') #make predictions of habitat suitability can include argument ext=ext
plot(px_hosts_and_habitat, main= 'Maxent, raw values')
writeRaster(px_hosts_and_habitat, filename="hosts_and_habitat_for_qgis.tif", format="GTiff", overwrite=TRUE) #exporting a GEOtiff

# 10% Min. Training Pres Threshold
training_suitability_hosts_and_habitat <- extract(px_hosts_and_habitat, thin_ptw_with_florida_coords) #all predicted values, all occs
training_suitability_hosts_and_habitat <- na.omit(training_suitability_hosts_and_habitat)
ten_thresh_hosts_and_habitat <- quantile(training_suitability_hosts_and_habitat, 0.1, na.rm = TRUE)
ten_thresh_hosts_and_habitat

# Confusion Matrix
training_suitability_hosts_and_habitat <- extract(px_hosts_and_habitat, thin_ptw_with_florida_coords) # extract predicted values, at known presence points
training_suitability_hosts_and_habitat <- na.omit(training_suitability_hosts_and_habitat)
pred_binary_hosts_and_habitat <- training_suitability_hosts_and_habitat > ten_thresh_hosts_and_habitat #where are known presence greater than threshold?
length(pred_binary_hosts_and_habitat[pred_binary_hosts_and_habitat==TRUE]) # these are "a" the true positives
length(pred_binary_hosts_and_habitat[pred_binary_hosts_and_habitat==FALSE]) #these are "c" the false negatives

background_suitability_hosts_and_habitat <- extract(px_hosts_and_habitat, backg_with_florida)
pred_binary_background_hosts_and_habitat <- background_suitability_hosts_and_habitat > ten_thresh_hosts_and_habitat

length(pred_binary_background_hosts_and_habitat[pred_binary_background_hosts_and_habitat==TRUE]) #these are "b" the false pos
length(pred_binary_background_hosts_and_habitat[pred_binary_background_hosts_and_habitat==FALSE]) # these are "d" the true neg 


####################################################################################################
################################### MaxEnt for Climate & Hosts & LULC ########################################
####################################################################################################

# k-fold
mx_climate_hosts_LULC_florida <- maxent(climate_and_hosts_and_LULC, thin_ptw_with_florida_coords, a=backg_with_florida, factors = "band1", 
                                        args=c('responsecurves=TRUE', 
                                               'replicatetype=crossvalidate', 'replicates=5',
                                               'writebackgroundpredictions=TRUE','outputgrids=TRUE'))
mx_climate_hosts_LULC_florida@results
names(climate_and_hosts_and_LULC)

# all occurrences
mx_climate_hosts_LULC_florida_full <- maxent(climate_and_hosts_and_LULC, thin_ptw_with_florida_coords, a=backg_with_florida, factors = "band1",
                                                  args=c('responsecurves=TRUE',
                                                         'writebackgroundpredictions=TRUE'))


plot(mx_climate_hosts_LULC_florida_full)
mx_climate_hosts_LULC_florida_full@results
mx_climate_hosts_LULC_florida_full@lambdas

px_climate_hosts_LULC_florida <- predict(climate_and_hosts_and_LULC, mx_climate_hosts_LULC_florida_full, progress='text') #make predictions of habitat suitability can include argument ext=ext
plot(px_climate_hosts_LULC_florida, main= 'Maxent, raw values')
writeRaster(px_climate_hosts_LULC_florida, filename="climate_hosts_LULC_with_florida_for_qgis.tif", format="GTiff", overwrite=TRUE) #exporting a GEOtiff

# 10% Min. Training Pres Threshold
training_suitability_climate_host_LULC <- extract(px_climate_hosts_LULC_florida, thin_ptw_with_florida_coords) #all predicted values, all occs
training_suitability_climate_host_LULC <- na.omit(training_suitability_climate_host_LULC)
ten_thresh_climate_host_LULC <- quantile(training_suitability_climate_host_LULC, 0.1, na.rm = TRUE)
ten_thresh_climate_host_LULC

# Confusion Matrix
training_suitability_climate_hosts_LULC <- extract(px_climate_hosts_LULC_florida, thin_ptw_with_florida_coords) # extract predicted values, at known presence points
training_suitability_climate_hosts_LULC <- na.omit(training_suitability_climate_hosts_LULC)
pred_binary_climate_hosts_LULC <- training_suitability_climate_hosts_LULC > ten_thresh_climate_host_LULC #where are known presence greater than threshold?
length(pred_binary_climate_hosts_LULC[pred_binary_climate_hosts_LULC==TRUE]) # these are "a" the true positives
length(pred_binary_climate_hosts_LULC[pred_binary_climate_hosts_LULC==FALSE]) #these are "c" the false negatives

background_suitability_climate_hosts_LULC <- extract(px_climate_hosts_LULC_florida, backg_with_florida)
pred_binary_background_climate_hosts_LULC <- background_suitability_climate_hosts_LULC > ten_thresh_climate_host_LULC

length(pred_binary_background_climate_hosts_LULC[pred_binary_background_climate_hosts_LULC==TRUE]) #these are "b" the false pos
length(pred_binary_background_climate_hosts_LULC[pred_binary_background_climate_hosts_LULC==FALSE]) # these are "d" the true neg 


####################################################################################################
######################################### Heat Map #################################################
####################################################################################################

# Convert Predictions to Data.Frames
map_climate <- rasterToPoints(px_climate_full_florida) #make predictions raster a set of points for ggplot
df_climate <- data.frame(map_climate) #convert to data.frame
colnames(df_climate) <- c('lon', 'lat', 'Suitability') #Make appropriate column headings

map_hosts <- rasterToPoints(px_hosts_model) #make predictions raster a set of points for ggplot
df_hosts <- data.frame(map_hosts) #convert to data.frame
colnames(df_hosts) <- c('lon', 'lat', 'Suitability') #Make appropriate column headings

map_LULC <- rasterToPoints(px_LULC_model_full_occurrences) #make predictions raster a set of points for ggplot
df_LULC <- data.frame(map_LULC) #convert to data.frame
colnames(df_LULC) <- c('lon', 'lat', 'Suitability') #Make appropriate column headings

map_climate_and_LULC <- rasterToPoints(px_climate_and_LULC_model) #make predictions raster a set of points for ggplot
df_climate_and_LULC <- data.frame(map_climate_and_LULC) #convert to data.frame
colnames(df_climate_and_LULC) <- c('lon', 'lat', 'Suitability') #Make appropriate column headings

map_climate_and_hosts <- rasterToPoints(px_climate_and_hosts) #make predictions raster a set of points for ggplot
df_climate_and_hosts <- data.frame(map_climate_and_hosts) #convert to data.frame
colnames(df_climate_and_hosts) <- c('lon', 'lat', 'Suitability') #Make appropriate column headings

map_hosts_and_habitat <- rasterToPoints(px_hosts_and_habitat) #make predictions raster a set of points for ggplot
df_hosts_and_habitat <- data.frame(map_hosts_and_habitat) #convert to data.frame
colnames(df_hosts_and_habitat) <- c('lon', 'lat', 'Suitability') #Make appropriate column headings

map_climate_hosts_LULC <- rasterToPoints(px_climate_hosts_LULC_florida) #make predictions raster a set of points for ggplot
df_climate_hosts_LULC <- data.frame(map_climate_hosts_LULC) #convert to data.frame
colnames(df_climate_hosts_LULC) <- c('lon', 'lat', 'Suitability') #Make appropriate column headings

# Make Binary Maps
df_climate_pres <- df_climate %>% mutate(pres_climate = ifelse(Suitability >= ten_thresh_climate, 1, 0))
df_climate_pres <- df_climate_pres[,c(1,2,4)] #get only binary output

ten_thresh_hosts_model
df_hosts_pres <- df_hosts %>% mutate(pres_hosts = ifelse(Suitability > ten_thresh_hosts_model, 1, 0))
head(df_hosts_pres)
df_hosts_pres$Suitability
min(df_hosts_pres$Suitability)
table(df_hosts_pres$pres_hosts)
df_hosts_pres <- df_hosts_pres[,c(1,2,4)] #get only binary output

df_LULC_pres <- df_LULC %>% mutate(pres_LULC = ifelse(Suitability >= ten_thresh_LULC, 1, 0))
head(df_LULC_pres)
df_LULC_pres <- df_LULC_pres[,c(1,2,4)] #get only binary output

df_climate_and_hosts_pres <- df_climate_and_hosts %>% mutate(pres_climate_and_host = ifelse(Suitability >= ten_thresh_climate_and_hosts, 1, 0))
head(df_climate_and_hosts_pres)
df_climate_and_hosts_pres <- df_climate_and_hosts_pres[,c(1,2,4)] #get only binary output

df_hosts_and_habitat_pres <- df_hosts_and_habitat %>% mutate(pres_hosts_and_habitat = ifelse(Suitability >= ten_thresh_hosts_and_habitat, 1, 0))
head(df_hosts_and_habitat_pres)
df_hosts_and_habitat_pres <- df_hosts_and_habitat_pres[,c(1,2,4)] #get only binary output

df_climate_and_LULC_pres <- df_climate_and_LULC %>% mutate(pres_climate_and_LULC = ifelse(Suitability >= ten_thresh_climate_and_LULC, 1, 0))
head(df_climate_and_LULC_pres)
df_climate_and_LULC_pres <- df_climate_and_LULC_pres[,c(1,2,4)] #get only binary output

df_climate_hosts_LULC_pres <- df_climate_hosts_LULC %>% mutate(pres_climate_host_LULC = ifelse(Suitability >= ten_thresh_climate_host_LULC, 1, 0))
head(df_climate_hosts_LULC_pres)
df_climate_hosts_LULC_pres <- df_climate_hosts_LULC_pres[,c(1,2,4)] #get only binary output

# # Gather all for heatmap
# df_all_presence <- left_join(df_climate_pres, df_hosts_pres, by = c("lon", "lat"),suffix = c(".x", ".y"))
# head(df_all_presence)
# df_all_presence$total <- rowSums(df_all_presence[, c(3, 4)])

# Converting Heatmap to geotiff
# head(df_all_presence)
# df_all_presences_combined<-df_all_presence[,c(1,2,5)]
# head(df_all_presences_combined)
# coordinates(df_all_presences_combined) <- ~ lon + lat
# gridded(df_all_presences_combined) <- TRUE
# raster_of_heatmap <- raster(df_all_presences_combined)
# writeRaster(raster_of_heatmap, filename="all_presence_combined_whydah.tif", format="GTiff", overwrite=TRUE)

# Binary map for climate
coordinates(df_climate_pres) <- ~ lon + lat
gridded(df_climate_pres) <- TRUE
raster_climate_model <- raster(df_climate_pres)
writeRaster(raster_climate_model, filename="climate_pres_raster_new.tif", format="GTiff", overwrite=TRUE)

# Binary map for hosts
coordinates(df_hosts_pres) <- ~ lon + lat
gridded(df_hosts_pres) <- TRUE
raster_hosts_pres <- raster(df_hosts_pres)
writeRaster(raster_hosts_pres, filename="hosts_pres_raster_new.tif", format="GTiff", overwrite=TRUE)

# Binary map for LULC
coordinates(df_LULC_pres) <- ~ lon + lat
gridded(df_LULC_pres) <- TRUE
raster_LULC_pres <- raster(df_LULC_pres)
writeRaster(raster_LULC_pres, filename="LULC_pres_raster_new.tif", format="GTiff", overwrite=TRUE)

# Binary map for climate & hosts
coordinates(df_climate_and_hosts_pres) <- ~ lon + lat
gridded(df_climate_and_hosts_pres) <- TRUE
raster_climate_host_pres <- raster(df_climate_and_hosts_pres)
writeRaster(raster_climate_host_pres, filename="climate_host_pres_raster_new.tif", format="GTiff", overwrite=TRUE)

# Binary map for hosts and habitat
coordinates(df_hosts_and_habitat_pres) <- ~ lon + lat
gridded(df_hosts_and_habitat_pres) <- TRUE
raster_hosts_and_habitat_pres <- raster(df_hosts_and_habitat_pres)
writeRaster(raster_hosts_and_habitat_pres, filename="hosts_and_habitat_pres_raster_new.tif", format="GTiff", overwrite=TRUE)

# Binary map for climate & LULC
coordinates(df_climate_and_LULC_pres) <- ~ lon + lat
gridded(df_climate_and_LULC_pres) <- TRUE
raster_climate_LULC_pres <- raster(df_climate_and_LULC_pres)
writeRaster(raster_climate_LULC_pres, filename="climate_LULC_pres_raster_new.tif", format="GTiff", overwrite=TRUE)

# Binary map for climate & hosts & LULC
coordinates(df_climate_hosts_LULC_pres) <- ~ lon + lat
gridded(df_climate_hosts_LULC_pres) <- TRUE
raster_climate_host_LULC_pres <- raster(df_climate_hosts_LULC_pres)
writeRaster(raster_climate_host_LULC_pres, filename="climate_host_LULC_raster.tif", format="GTiff", overwrite=TRUE)

####################################################################################################
########################### Predicted Occupied Area for North America ##############################
####################################################################################################

# Make object for extent of North America
north_america_extent <-c(-162,-55,11.5,55)
setwd('/Users/rpecchia/Desktop/Whydah Project/whydah/Data')

antilles <- readOGR(dsn = ".", layer = "north_america_antilles_shapefile")
plot(antilles)
usa <- readOGR(dsn = ".", layer = "north_america_shapefile")
plot(usa)

CNTY_ID <- "30"
length(CNTY_ID)
row.names(as(usa, "data.frame"))
row.names(as(antilles, "data.frame"))
usa2 <- spChFIDs(usa, as.character(30))

usa_and_antilles <- spRbind(usa2,antilles)

# Climate Raster of NA
climate_north_america_binary <- crop(raster_climate_model, north_america_extent)
plot(climate_north_america_binary)
climate_usa_antilles_binary <- mask(climate_north_america_binary, usa_and_antilles)
plot(climate_usa_antilles_binary)
total_cells_climate <- sum(na.omit(climate_usa_antilles_binary@data@values))
total_cells_climate * 10

# Host Raster of NA
host_north_america_binary <- crop(raster_hosts_pres, north_america_extent)
host_usa_antilles_binary <- mask(host_north_america_binary, usa_and_antilles)
total_cells_host <- sum(na.omit(host_usa_antilles_binary@data@values))
plot(host_usa_antilles_binary)
total_cells_host * 10

# habitat Raster of NA
habitat_north_america_binary <- crop(raster_LULC_pres, north_america_extent)
plot(habitat_north_america_binary)
habitat_usa_antilles_binary <- mask(habitat_north_america_binary, usa_and_antilles)
plot(habitat_usa_antilles_binary)
total_cells_habitat <- sum(na.omit(habitat_usa_antilles_binary@data@values))
total_cells_habitat * 10

# host and habitat raster of NA
host_and_habitat_north_america_binary <- crop(raster_hosts_and_habitat_pres, north_america_extent)
plot(host_and_habitat_north_america_binary)
host_and_habitat_usa_antilles_binary <- mask(host_and_habitat_north_america_binary, usa_and_antilles)
plot(host_and_habitat_usa_antilles_binary)
total_cells_host_and_habitat <- sum(na.omit(host_and_habitat_usa_antilles_binary@data@values))
total_cells_host_and_habitat * 10

# climate and host  Raster of NA
climate_and_host_north_america_binary <- crop(raster_climate_host_pres, north_america_extent)
plot(climate_and_host_north_america_binary)
climate_and_host_usa_antilles_binary <- mask(climate_and_host_north_america_binary, usa_and_antilles)
plot(climate_and_host_usa_antilles_binary)
total_cells_climate_and_host <- sum(na.omit(climate_and_host_usa_antilles_binary@data@values))
total_cells_climate_and_host * 10

# climate and habitat Raster of NA
climate_and_habitat_north_america_binary <- crop(raster_climate_LULC_pres, north_america_extent)
plot(climate_and_habitat_north_america_binary)
climate_and_habitat_usa_antilles_binary <- mask(climate_and_habitat_north_america_binary, usa_and_antilles)
plot(climate_and_habitat_usa_antilles_binary)
total_cells_climate_and_habitat <- sum(na.omit(climate_and_habitat_usa_antilles_binary@data@values))
total_cells_climate_and_habitat * 10

# climate and habitat and host  Raster of NA
climate_host_habitat_north_america_binary <- crop(raster_climate_host_LULC_pres, north_america_extent)
plot(climate_host_habitat_north_america_binary)
climate_host_habitat_usa_antilles_binary <- mask(climate_host_habitat_north_america_binary, usa_and_antilles)
plot(climate_host_habitat_usa_antilles_binary)
total_cells_climate_and_host_and_habitat <- sum(na.omit(climate_host_habitat_usa_antilles_binary@data@values))
total_cells_climate_and_host_and_habitat * 10

####################################################################################################
#################################### Calculating Schoner's D #######################################
####################################################################################################

naive_asc <- writeRaster(no_host_usa_antilles_binary, filename = 'naive_model.asc', format = "ascii", overwrite = TRUE)
exotic_asc <- writeRaster(exotic_host_usa_antilles_binary, filename = "exotics_model.asc", format = "ascii", overwrite = TRUE)

naive_asc <- read.asc("naive_model.asc")
exotic_asc <- read.asc("exotics_model.asc")

naive_grid <- sp.from.asc(naive_asc)
exotic_grid <- sp.from.asc(exotic_asc)

no <- niche.overlap(list(naive = naive_grid, exotic.host = exotic_grid))
no #upper triangle is Schoner's, Lower is Hellinger's

### New Thresholds


ten_thresh_hosts

e1 <- evaluate(mx_climate_full_florida, p=thin_ptw_with_florida_coords, a=backg_with_florida, x=climate)
threshold(e1)

e2 <- evaluate(mx_hosts_florida, p=thin_ptw_with_florida_coords, a=backg_with_florida, x=climate)
threshold(e2)



